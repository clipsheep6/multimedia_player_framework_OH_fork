From 731481219795aef33c31fdcb84a31b87c2a53138 Mon Sep 17 00:00:00 2001
From: caochuan <caochuan@huawei.com>
Date: Wed, 20 Mar 2024 16:22:14 +0800
Subject: [PATCH] prepare download for huawei

Change-Id: Ic845d259a7663323847cf8dfdfc09b411bba0d0e
---
 config.gni                                    |   5 +
 frameworks/js/avplayer/BUILD.gn               |   2 +
 frameworks/js/avplayer/avplayer_napi.cpp      |  51 +++++++
 frameworks/js/avplayer/avplayer_napi.h        |   2 +
 frameworks/js/common/common_napi.cpp          |  43 ++++++
 frameworks/js/common/common_napi.h            |  24 +++
 .../js/media/native_module_ohos_media.cpp     |   4 +
 .../js/mediasource/media_source_napi.cpp      | 143 ++++++++++++++++++
 frameworks/js/mediasource/media_source_napi.h |  53 +++++++
 frameworks/native/player/player_impl.cpp      |   8 +
 frameworks/native/player/player_impl.h        |   1 +
 interfaces/inner_api/native/player.h          |  10 ++
 interfaces/kits/js/BUILD.gn                   |   2 +
 interfaces/kits/js/native_module_ohos_media.h |   1 +
 .../player/player_engine_gst_impl.cpp         |  15 ++
 .../gstreamer/player/player_engine_gst_impl.h |   1 +
 .../histreamer/player/hiplayer_impl.cpp       |  10 ++
 .../engine/histreamer/player/hiplayer_impl.h  |   6 +
 services/include/i_player_service.h           |   1 +
 .../services/engine_intf/i_player_engine.h    |   1 +
 .../services/player/client/player_client.cpp  |   7 +
 .../services/player/client/player_client.h    |   1 +
 .../player/ipc/i_standard_player_service.h    |   2 +
 .../player/ipc/player_service_proxy.cpp       |  38 +++++
 .../player/ipc/player_service_proxy.h         |   1 +
 .../player/ipc/player_service_stub.cpp        |  30 ++++
 .../services/player/ipc/player_service_stub.h |   2 +
 .../services/player/server/player_server.cpp  |   6 +
 .../services/player/server/player_server.h    |   1 +
 29 files changed, 471 insertions(+)
 create mode 100644 frameworks/js/mediasource/media_source_napi.cpp
 create mode 100644 frameworks/js/mediasource/media_source_napi.h

diff --git a/config.gni b/config.gni
index 190c9e53..63141715 100644
--- a/config.gni
+++ b/config.gni
@@ -30,6 +30,7 @@ declare_args() {
   multimedia_player_framework_support_seccomp = false
   multimedia_player_framework_support_screen_capture = true
   multimedia_player_framework_support_jssoundpool = true
+  multimedia_player_framework_support_mediasource = true
   if (defined(build_seccomp) && build_seccomp) {
     multimedia_player_framework_support_seccomp = true
   }
@@ -158,6 +159,10 @@ if (multimedia_player_framework_support_power_manager) {
   player_framework_defines += [ "SUPPORT_POWER_MANAGER" ]
 }
 
+if (multimedia_player_framework_support_mediasource) {
+  player_framework_defines += [ "SUPPORT_MEDIA_SOURCE" ]
+}
+
 # Config path
 MEDIA_PLAYER_ROOT_DIR = "//foundation/multimedia/player_framework"
 MEDIA_PLAYER_AVCODEC = "//foundation/multimedia/av_codec"
diff --git a/frameworks/js/avplayer/BUILD.gn b/frameworks/js/avplayer/BUILD.gn
index daaeb68d..e6d37fd0 100644
--- a/frameworks/js/avplayer/BUILD.gn
+++ b/frameworks/js/avplayer/BUILD.gn
@@ -26,6 +26,7 @@ ohos_shared_library("media_avplayer") {
     "//foundation/multimedia/player_framework/interfaces/inner_api",
     "//foundation/multimedia/player_framework/frameworks/js/avplayer",
     "//foundation/multimedia/player_framework/frameworks/js/common",
+    "//foundation/multimedia/player_framework/frameworks/js/mediasource",
     "//foundation/multimedia/player_framework/services/utils/include",
     "//third_party/libuv/include",
   ]
@@ -35,6 +36,7 @@ ohos_shared_library("media_avplayer") {
     "//foundation/multimedia/player_framework/frameworks/js/avplayer/avplayer_callback.cpp",
     "//foundation/multimedia/player_framework/frameworks/js/avplayer/avplayer_napi.cpp",
     "//foundation/multimedia/player_framework/frameworks/js/common/common_napi.cpp",
+    "//foundation/multimedia/player_framework/frameworks/js/mediasource/media_source_napi.cpp"
   ]
 
   cflags = [
diff --git a/frameworks/js/avplayer/avplayer_napi.cpp b/frameworks/js/avplayer/avplayer_napi.cpp
index c9efd3b7..d5d9b31e 100644
--- a/frameworks/js/avplayer/avplayer_napi.cpp
+++ b/frameworks/js/avplayer/avplayer_napi.cpp
@@ -32,6 +32,7 @@
 #endif
 #include "av_common.h"
 #include "meta/video_types.h"
+#include "media_source_napi.h"
 
 using namespace OHOS::AudioStandard;
 
@@ -72,6 +73,7 @@ napi_value AVPlayerNapi::Init(napi_env env, napi_value exports)
         DECLARE_NAPI_FUNCTION("off", JsClearOnCallback),
         DECLARE_NAPI_FUNCTION("setVolume", JsSetVolume),
         DECLARE_NAPI_FUNCTION("setSpeed", JsSetSpeed),
+        DECLARE_NAPI_FUNCTION("setMediaSource", JsSetMediaSource),
         DECLARE_NAPI_FUNCTION("setBitrate", JsSelectBitrate),
         DECLARE_NAPI_FUNCTION("getTrackDescription", JsGetTrackDescription),
         DECLARE_NAPI_FUNCTION("selectTrack", JsSelectTrack),
@@ -1254,6 +1256,55 @@ napi_value AVPlayerNapi::JsGetAVFileDescriptor(napi_env env, napi_callback_info
     return value;
 }
 
+napi_value AVPlayerNapi::JsSetMediaSource(napi_env env, napi_callback_info info)
+{
+    MEDIA_LOGE("AVPlayerNapi JsSetMediaSource");
+    MediaTrace trace("AVPlayerNapi::JsSetMediaSource");
+    napi_value result = nullptr;
+    napi_get_undefined(env, &result);
+    napi_value args[2] = { nullptr };
+    size_t argCount = 2;
+    AVPlayerNapi *jsPlayer = AVPlayerNapi::GetJsInstanceWithParameter(env, info, argCount, args);
+    CHECK_AND_RETURN_RET_LOG(jsPlayer != nullptr, result, "failed to GetJsInstanceWithParameter");
+
+    if (jsPlayer->IsLiveSource()) {
+        jsPlayer->OnErrorCb(MSERR_EXT_API9_UNSUPPORT_CAPABILITY, "The stream is live stream, not support seek");
+        return result;
+    }
+    napi_valuetype valueType = napi_undefined;
+    if (argCount < 2 || napi_typeof(env, args[0], &valueType) != napi_ok || valueType != napi_object
+        || napi_typeof(env, args[1], &valueType) != napi_ok || valueType != napi_object) {
+        jsPlayer->OnErrorCb(MSERR_EXT_API9_INVALID_PARAMETER, "SetMediaSource is not napi_object");
+    }
+
+    std::shared_ptr<AVMediaSource> mediaSource = MediaSourceNapi::GetMediaSource(env, args[0]);
+    if (mediaSource == nullptr)
+    {
+        MEDIA_LOGE("mediaSource is null");
+    }
+    
+    struct AVPlayStrategyForTemp strategyTmp;
+    struct AVPlayStrategy strategy;
+    if (!CommonNapi::GetPlayStrategy(env, args[1], strategyTmp)) {
+        MEDIA_LOGE("get fileDescriptor argument failed!");
+        jsPlayer->OnErrorCb(MSERR_EXT_API9_INVALID_PARAMETER,
+            "invalid parameters, please check the input parameters(fileDescriptor)");
+        return result;
+    }
+    strategy.preferedBufferDuration = strategyTmp.preferedBufferDuration;
+    strategy.preferedHeight = strategyTmp.preferedHeight;
+    strategy.preferedWidth = strategyTmp.preferedWidth;
+    strategy.preferHDR = strategyTmp.preferHDR;
+    MEDIA_LOGE("AVPlayerNapi JsSetMediaSource Passed");
+    auto task = std::make_shared<TaskHandler<void>>([jsPlayer, mediaSource, strategy]() {
+        if (jsPlayer->player_ != nullptr) {
+            (void)jsPlayer->player_->SetMediaSource(mediaSource->header, strategy);
+        }
+    });
+    (void)jsPlayer->taskQue_->EnqueueTask(task);
+    return result;
+}
+
 napi_value AVPlayerNapi::JsSetDataSrc(napi_env env, napi_callback_info info)
 {
     MediaTrace trace("AVPlayerNapi::set dataSrc");
diff --git a/frameworks/js/avplayer/avplayer_napi.h b/frameworks/js/avplayer/avplayer_napi.h
index 4f4d4629..cadfdd70 100644
--- a/frameworks/js/avplayer/avplayer_napi.h
+++ b/frameworks/js/avplayer/avplayer_napi.h
@@ -222,6 +222,8 @@ private:
      * setDecryptionConfig(mediaKeySession: drm.MediaKeySession, secureVideoPath: boolean): void;
      */
     static napi_value JsSetDecryptConfig(napi_env env, napi_callback_info info);
+
+    static napi_value JsSetMediaSource(napi_env env, napi_callback_info info);
     /**
      * getMediaKeySystemInfos(): Array<MediaKeySystemInfo>;
      */
diff --git a/frameworks/js/common/common_napi.cpp b/frameworks/js/common/common_napi.cpp
index bb1dae17..7c50d5ec 100644
--- a/frameworks/js/common/common_napi.cpp
+++ b/frameworks/js/common/common_napi.cpp
@@ -161,6 +161,49 @@ bool CommonNapi::GetFdArgument(napi_env env, napi_value value, AVFileDescriptor
     return true;
 }
 
+bool CommonNapi::GetPropertyMap(napi_env env, napi_value value, std::map<std::string, std::string>& map)
+{
+    napi_value jsProNameList = nullptr;
+    uint32_t jsProCount = 0;
+    napi_status status = napi_get_property_names(env, value, &jsProNameList);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, false, "get property name failed");
+    status = napi_get_array_length(env, jsProNameList, &jsProCount);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, false, "get subKeys length failed");
+
+    napi_value jsProName = nullptr;
+    napi_value jsProValue = nullptr;
+    for (uint32_t i = 0; i < jsProCount; i++) {
+        status = napi_get_element(env, jsProNameList, i, &jsProName);
+        CHECK_AND_RETURN_RET_LOG(status == napi_ok, false, "get sub key failed");
+        std::string strProName = GetStringArgument(env, jsProName);
+
+        status = napi_get_named_property(env, value, strProName.c_str(), &jsProValue);
+        CHECK_AND_RETURN_RET_LOG(status == napi_ok, false, "get sub value failed");
+        std::string strProValue = GetStringArgument(env, jsProValue);
+
+        map.emplace(strProName, strProValue);
+    }
+
+    return true;
+}
+
+bool CommonNapi::GetPlayStrategy(napi_env env, napi_value value, AVPlayStrategyForTemp &playStrategy)
+{
+    if (!GetPropertyUint32(env, value, "preferedWidth", playStrategy.preferedWidth)) {
+        playStrategy.preferedWidth = 0; // use default value
+    }
+    if (!GetPropertyUint32(env, value, "preferedHeight", playStrategy.preferedHeight)) {
+        playStrategy.preferedHeight = 0; // use default value
+    }
+    if (!GetPropertyUint32(env, value, "preferedBufferDuration", playStrategy.preferedBufferDuration)) {
+        playStrategy.preferedBufferDuration = 0; // use default value
+    }
+    if (!GetPropertyBool(env, value, "preferedWidth", playStrategy.preferHDR )) {
+        playStrategy.preferHDR = 0; // use default value
+    }
+    return true;
+}
+
 napi_status CommonNapi::FillErrorArgs(napi_env env, int32_t errCode, const napi_value &args)
 {
     napi_value codeStr = nullptr;
diff --git a/frameworks/js/common/common_napi.h b/frameworks/js/common/common_napi.h
index 795aa672..3f660ccb 100644
--- a/frameworks/js/common/common_napi.h
+++ b/frameworks/js/common/common_napi.h
@@ -16,6 +16,7 @@
 #ifndef COMMON_NAPI_H
 #define COMMON_NAPI_H
 
+#include <map>
 #include <string>
 #include <vector>
 #include <unordered_map>
@@ -30,6 +31,9 @@
 namespace OHOS {
 namespace Media {
 struct AVFileDescriptor;
+struct AVPlayStrategyForTemp;
+struct AVDataSrcDescriptor;
+class AVMediaSource;
 
 class CommonNapi {
 public:
@@ -42,7 +46,9 @@ public:
     static bool GetPropertyInt64(napi_env env, napi_value configObj, const std::string &type, int64_t &result);
     static bool GetPropertyDouble(napi_env env, napi_value configObj, const std::string &type, double &result);
     static std::string GetPropertyString(napi_env env, napi_value configObj, const std::string &type);
+    static bool GetPropertyMap(napi_env env, napi_value value, std::map<std::string, std::string>& map);
     static bool GetFdArgument(napi_env env, napi_value value, AVFileDescriptor &rawFd);
+    static bool GetPlayStrategy(napi_env env, napi_value value, AVPlayStrategyForTemp &playStrategy);
     static napi_status FillErrorArgs(napi_env env, int32_t errCode, const napi_value &args);
     static napi_status CreateError(napi_env env, int32_t errCode, const std::string &errMsg, napi_value &errVal);
     static napi_ref CreateReference(napi_env env, napi_value arg);
@@ -296,6 +302,24 @@ struct AVDataSrcDescriptor {
     napi_value callback = nullptr;
 };
 
+class AVMediaSource {
+public:
+    AVMediaSource() = default;
+    ~AVMediaSource()
+    {
+        header.clear();
+    }
+    std::map<std::string, std::string> header;
+    std::string url {0};
+};
+
+struct AVPlayStrategyForTemp {
+    uint32_t preferedWidth;
+    uint32_t preferedHeight;
+    uint32_t preferedBufferDuration;
+    bool preferHDR; 
+};
+
 template<typename T>
 class ObjectRefMap {
 public:
diff --git a/frameworks/js/media/native_module_ohos_media.cpp b/frameworks/js/media/native_module_ohos_media.cpp
index 7ef549f9..60cfff99 100644
--- a/frameworks/js/media/native_module_ohos_media.cpp
+++ b/frameworks/js/media/native_module_ohos_media.cpp
@@ -51,6 +51,10 @@ static napi_value Export(napi_env env, napi_value exports)
 #ifdef SUPPORT_SOUND_POOL
     OHOS::Media::SoundPoolNapi::Init(env, exports);
 #endif
+#ifdef SUPPORT_MEDIA_SOURCE
+    OHOS::Media::MediaSourceNapi::Init(env, exports);
+#endif
+
     return exports;
 }
 
diff --git a/frameworks/js/mediasource/media_source_napi.cpp b/frameworks/js/mediasource/media_source_napi.cpp
new file mode 100644
index 00000000..da5b3403
--- /dev/null
+++ b/frameworks/js/mediasource/media_source_napi.cpp
@@ -0,0 +1,143 @@
+/*
+ * Copyright (C) 2024 Huawei Device Co., Ltd.
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#include "media_source_napi.h"
+#include "media_log.h"
+
+namespace {
+    constexpr OHOS::HiviewDFX::HiLogLabel LABEL = {LOG_CORE, LOG_DOMAIN, "MediaSourceNapi"};
+}
+
+namespace OHOS {
+namespace Media {
+
+const std::string CLASS_NAME = "MediaSource";
+thread_local napi_ref MediaSourceNapi::constructor_ = nullptr;
+
+napi_value MediaSourceNapi::Init(napi_env env, napi_value exports)
+{
+    napi_property_descriptor staticProperty[] = {
+        DECLARE_NAPI_STATIC_FUNCTION("createMediaSourceWithURL", JsCreateMediaSourceWithUrl),
+    };
+    napi_property_descriptor properties[] = {
+        DECLARE_NAPI_FUNCTION("setTimeRange", JsSetTimeRange),
+    };
+
+    napi_value constructor = nullptr;
+    napi_status status = napi_define_class(env, CLASS_NAME.c_str(), NAPI_AUTO_LENGTH, Constructor, nullptr,
+        sizeof(properties) / sizeof(properties[0]), properties, &constructor);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, nullptr, "Failed to define AVPlayer class");
+
+    status = napi_create_reference(env, constructor, 1, &constructor_);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, nullptr, "Failed to create reference of constructor");
+
+    status = napi_set_named_property(env, exports, CLASS_NAME.c_str(), constructor);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, nullptr, "Failed to set constructor");
+
+    status = napi_define_properties(env, exports, sizeof(staticProperty) / sizeof(staticProperty[0]), staticProperty);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, nullptr, "Failed to define static function");
+    return exports;
+}
+
+std::shared_ptr<AVMediaSource> MediaSourceNapi::GetMediaSource(napi_env env, napi_value jsMediaSource)
+{
+    MediaSourceNapi *mediaSource = nullptr;
+    napi_status status = napi_unwrap(env, jsMediaSource, reinterpret_cast<void **>(&mediaSource));
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok && mediaSource != nullptr, nullptr, "failed to napi_unwrap");
+
+    return mediaSource->mediaSource_;
+}
+
+napi_value MediaSourceNapi::Constructor(napi_env env, napi_callback_info info)
+{
+    napi_value result = nullptr;
+    napi_get_undefined(env, &result);
+
+    size_t argCount = 0;
+    napi_value jsThis = nullptr;
+    napi_status status = napi_get_cb_info(env, info, &argCount, nullptr, &jsThis, nullptr);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, result, "failed to napi_get_cb_info");
+
+    MediaSourceNapi *jsMediaSource = new(std::nothrow) MediaSourceNapi();
+    CHECK_AND_RETURN_RET_LOG(jsMediaSource != nullptr, result, "failed to new MediaSourceNapi");
+
+    jsMediaSource->env_ = env;
+    jsMediaSource->mediaSource_ = std::make_shared<AVMediaSource>();
+    CHECK_AND_RETURN_RET_LOG(jsMediaSource->mediaSource_ != nullptr, result, "failed to Create MediaSource");
+
+    status = napi_wrap(env, jsThis, reinterpret_cast<void *>(jsMediaSource),
+        MediaSourceNapi::Destructor, nullptr, nullptr);
+    if (status != napi_ok) {
+        delete jsMediaSource;
+        MEDIA_LOGE("Failed to wrap native instance");
+        return result;
+    }
+
+    MEDIA_LOGI("0x%{public}06" PRIXPTR " Constructor success", FAKE_POINTER(jsMediaSource));
+    return jsThis;
+}
+
+void MediaSourceNapi::Destructor(napi_env env, void *nativeObject, void *finalize)
+{
+    (void)env;
+    (void)finalize;
+    if (nativeObject != nullptr) {
+        MediaSourceNapi *jsMediaSource = reinterpret_cast<MediaSourceNapi *>(nativeObject);
+        jsMediaSource->mediaSource_ = nullptr;
+        delete jsMediaSource;
+    }
+    MEDIA_LOGI("Destructor success");
+}
+
+napi_value MediaSourceNapi::JsCreateMediaSourceWithUrl(napi_env env, napi_callback_info info)
+{
+    MEDIA_LOGD("JsCreateMediaSourceWithUrl In");
+    MEDIA_LOGE("JsCreateMediaSourceWithUrl In");
+    size_t argCount = 2;
+    napi_value args[2] = { nullptr };
+    napi_value jsMediaSource = nullptr;
+    napi_get_undefined(env, &jsMediaSource);
+    napi_status status = napi_get_cb_info(env, info, &argCount, args, nullptr, nullptr);
+    CHECK_AND_RETURN_RET_LOG(status == napi_ok, nullptr, "failed to napi_get_cb_info");
+
+    napi_valuetype valueType = napi_undefined;
+    if (argCount < 1 || napi_typeof(env, args[0], &valueType) != napi_ok || valueType != napi_string) {
+        return nullptr;
+    }
+
+    napi_value constructor = nullptr;
+    napi_status ret = napi_get_reference_value(env, constructor_, &constructor);
+    if (ret != napi_ok || constructor == nullptr) {
+        return nullptr;
+    }
+    napi_new_instance(env, constructor, 0, nullptr, &jsMediaSource);
+
+    std::shared_ptr<AVMediaSource> mediaSource = GetMediaSource(env, jsMediaSource);
+    mediaSource->url = CommonNapi::GetStringArgument(env, args[0]);
+
+    if (argCount >= 2 && napi_typeof(env, args[1], &valueType) == napi_ok && valueType != napi_object) {
+        (void)CommonNapi::GetPropertyMap(env, args[1], mediaSource->header);
+    }
+    MEDIA_LOGE("JsCreateMediaSourceWithUrl  Passed");
+    return jsMediaSource;
+}
+
+napi_value MediaSourceNapi::JsSetTimeRange(napi_env env, napi_callback_info info)
+{
+    return nullptr;
+}
+
+} // Media
+} // OHOS
\ No newline at end of file
diff --git a/frameworks/js/mediasource/media_source_napi.h b/frameworks/js/mediasource/media_source_napi.h
new file mode 100644
index 00000000..b149614d
--- /dev/null
+++ b/frameworks/js/mediasource/media_source_napi.h
@@ -0,0 +1,53 @@
+/*
+ * Copyright (C) 2024 Huawei Device Co., Ltd.
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#ifndef MEDIA_SOURCE_NAPI_H
+#define MEDIA_SOURCE_NAPI_H
+
+#include "napi/native_api.h"
+#include "napi/native_node_api.h"
+#include "common_napi.h"
+
+namespace OHOS {
+namespace Media {
+
+class MediaSourceNapi {
+public:
+    __attribute__((visibility("default"))) static napi_value Init(napi_env env, napi_value exports);
+    static std::shared_ptr<AVMediaSource> GetMediaSource(napi_env env, napi_value jsMediaSource);
+private:
+    static napi_value Constructor(napi_env env, napi_callback_info info);
+    static void Destructor(napi_env env, void *nativeObject, void *finalize);
+    /**
+     * function createMediaSourceWithURL(url: string, header?: string): MediaSource
+     */
+    static napi_value JsCreateMediaSourceWithUrl(napi_env env, napi_callback_info info);
+    /**
+     * setTimeRange(startTime? : number, endTime? : number): void
+     */
+    static napi_value JsSetTimeRange(napi_env env, napi_callback_info info);
+
+    MediaSourceNapi() = default;
+    virtual ~MediaSourceNapi() = default;
+
+    static thread_local napi_ref constructor_;
+    napi_env env_ = nullptr;
+    std::shared_ptr<AVMediaSource> mediaSource_ {nullptr};
+};
+
+} // Media
+} // OHOS
+
+#endif // MEDIA_SOURCE_NAPI_H
\ No newline at end of file
diff --git a/frameworks/native/player/player_impl.cpp b/frameworks/native/player/player_impl.cpp
index 2dd04b5f..3432eec2 100644
--- a/frameworks/native/player/player_impl.cpp
+++ b/frameworks/native/player/player_impl.cpp
@@ -222,6 +222,14 @@ int32_t PlayerImpl::SetPlaybackSpeed(PlaybackRateMode mode)
     return playerService_->SetPlaybackSpeed(mode);
 }
 
+int32_t PlayerImpl::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) 
+{
+
+    CHECK_AND_RETURN_RET_LOG(playerService_ != nullptr, MSERR_SERVICE_DIED, "player service does not exist..");
+    return playerService_->SetMediaSource(header, strategy);
+}
+
+
 int32_t PlayerImpl::GetPlaybackSpeed(PlaybackRateMode &mode)
 {
     MEDIA_LOGD("PlayerImpl:0x%{public}06" PRIXPTR " GetPlaybackSpeed in", FAKE_POINTER(this));
diff --git a/frameworks/native/player/player_impl.h b/frameworks/native/player/player_impl.h
index 0a1c8c5b..22c7a8e1 100644
--- a/frameworks/native/player/player_impl.h
+++ b/frameworks/native/player/player_impl.h
@@ -66,6 +66,7 @@ public:
     int32_t GetCurrentTrack(int32_t trackType, int32_t &index) override;
     int32_t SetDecryptConfig(const sptr<DrmStandard::IMediaKeySessionService> &keySessionProxy,
         bool svp) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
     int32_t Init();
 private:
     std::shared_ptr<IPlayerService> playerService_ = nullptr;
diff --git a/interfaces/inner_api/native/player.h b/interfaces/inner_api/native/player.h
index 99ba49e6..0327012a 100644
--- a/interfaces/inner_api/native/player.h
+++ b/interfaces/inner_api/native/player.h
@@ -27,6 +27,7 @@
 
 namespace OHOS {
 namespace Media {
+struct AVPlayStrategy;
 
 namespace DrmConstant {
 constexpr uint32_t DRM_MAX_M3U8_DRM_PSSH_LEN = 2048;
@@ -34,6 +35,13 @@ constexpr uint32_t DRM_MAX_M3U8_DRM_UUID_LEN = 16;
 constexpr uint32_t DRM_MAX_DRM_INFO_COUNT = 200;
 }
 
+struct AVPlayStrategy {
+    uint32_t preferedWidth;
+    uint32_t preferedHeight;
+    uint32_t preferedBufferDuration;
+    bool preferHDR; 
+};
+
 struct DrmInfoItem {
     uint8_t uuid[DrmConstant::DRM_MAX_M3U8_DRM_UUID_LEN];
     uint8_t pssh[DrmConstant::DRM_MAX_M3U8_DRM_PSSH_LEN];
@@ -385,6 +393,8 @@ public:
      */
     virtual int32_t SetVolume(float leftVolume, float rightVolume) = 0;
 
+    virtual int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) = 0;
+
     /**
      * @brief Changes the playback position.
      *
diff --git a/interfaces/kits/js/BUILD.gn b/interfaces/kits/js/BUILD.gn
index 9b3b7f57..3726e867 100644
--- a/interfaces/kits/js/BUILD.gn
+++ b/interfaces/kits/js/BUILD.gn
@@ -54,6 +54,7 @@ ohos_shared_library("media") {
     "//foundation/multimedia/player_framework/frameworks/js/player",
     "//foundation/multimedia/player_framework/frameworks/js/recorder",
     "//foundation/multimedia/player_framework/frameworks/js/media",
+    "//foundation/multimedia/player_framework/frameworks/js/mediasource",
     "//foundation/multimedia/player_framework/frameworks/js/common",
     "//foundation/multimedia/player_framework/services/utils/include",
     "${multimedia_player_framework_path}/frameworks/js/soundpool/include",
@@ -68,6 +69,7 @@ ohos_shared_library("media") {
     "//foundation/multimedia/player_framework/frameworks/js/common/common_napi.cpp",
     "//foundation/multimedia/player_framework/frameworks/js/media/media_enum_napi.cpp",
     "//foundation/multimedia/player_framework/frameworks/js/media/native_module_ohos_media.cpp",
+    "//foundation/multimedia/player_framework/frameworks/js/mediasource/media_source_napi.cpp"
   ]
 
   if (multimedia_player_framework_support_player) {
diff --git a/interfaces/kits/js/native_module_ohos_media.h b/interfaces/kits/js/native_module_ohos_media.h
index c590ae93..bb8b6c6f 100644
--- a/interfaces/kits/js/native_module_ohos_media.h
+++ b/interfaces/kits/js/native_module_ohos_media.h
@@ -28,5 +28,6 @@
 #include "soundpool_napi.h"
 #include "avmetadataextractor_napi.h"
 #include "avimagegenerator_napi.h"
+#include "media_source_napi.h"
 
 #endif /* NATIVE_MODULE_OHOS_MEDIA_H_ */
diff --git a/services/engine/gstreamer/player/player_engine_gst_impl.cpp b/services/engine/gstreamer/player/player_engine_gst_impl.cpp
index 68dfe28d..173fbea1 100644
--- a/services/engine/gstreamer/player/player_engine_gst_impl.cpp
+++ b/services/engine/gstreamer/player/player_engine_gst_impl.cpp
@@ -905,6 +905,21 @@ int32_t PlayerEngineGstImpl::SetVolume(float leftVolume, float rightVolume)
     return MSERR_OK;
 }
 
+int32_t PlayerEngineGstImpl::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy)
+{
+    std::unique_lock<std::mutex> lock(mutex_);
+    if (playBinCtrler_ != nullptr) {
+        for (const auto& pair : header) {
+            MEDIA_LOGD("header info %s", pair.first.c_str());
+        }
+        MEDIA_LOGD("SetMediaSource preferedWidth %d preferedHeight %d bufferDuration %d preferHDR %d", 
+            strategy.preferedWidth, strategy.preferedHeight, strategy.preferedBufferDuration , strategy.preferHDR);
+        //playBinCtrler_->SetDurationSize(durationSize);
+    }
+    return MSERR_OK;
+
+}
+
 int32_t PlayerEngineGstImpl::SelectBitRate(uint32_t bitRate)
 {
     std::unique_lock<std::mutex> lock(mutex_);
diff --git a/services/engine/gstreamer/player/player_engine_gst_impl.h b/services/engine/gstreamer/player/player_engine_gst_impl.h
index a5ad4087..581d389d 100644
--- a/services/engine/gstreamer/player/player_engine_gst_impl.h
+++ b/services/engine/gstreamer/player/player_engine_gst_impl.h
@@ -57,6 +57,7 @@ public:
     int32_t GetVideoTrackInfo(std::vector<Format> &videoTrack) override;
     int32_t GetDuration(int32_t &duration) override;
     int32_t SetPlaybackSpeed(PlaybackRateMode mode) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
     int32_t SetParameter(const Format &param) override;
     int32_t GetVideoHeight() override;
     int32_t SetLooping(bool loop) override;
diff --git a/services/engine/histreamer/player/hiplayer_impl.cpp b/services/engine/histreamer/player/hiplayer_impl.cpp
index 4ddf8c33..3e492558 100755
--- a/services/engine/histreamer/player/hiplayer_impl.cpp
+++ b/services/engine/histreamer/player/hiplayer_impl.cpp
@@ -182,6 +182,16 @@ int32_t HiPlayerImpl::SetSource(const std::string& uri)
     return TransStatus(Status::OK);
 }
 
+int32_t HiPlayerImpl::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy)
+{
+    this->header = header;
+    this->preferedWidth = strategy.preferedWidth;
+    this->preferedHeight = strategy.preferedHeight;
+    this->bufferDuration = strategy.preferedBufferDuration;
+    this->preferHDR = strategy.preferHDR;
+    return MSERR_OK;
+}
+
 int32_t HiPlayerImpl::SetSource(const std::shared_ptr<IMediaDataSource>& dataSrc)
 {
     MEDIA_LOG_I("SetSource entered source stream");
diff --git a/services/engine/histreamer/player/hiplayer_impl.h b/services/engine/histreamer/player/hiplayer_impl.h
index 3be9f371..ae0a3496 100755
--- a/services/engine/histreamer/player/hiplayer_impl.h
+++ b/services/engine/histreamer/player/hiplayer_impl.h
@@ -66,6 +66,7 @@ public:
     int32_t GetCurrentTime(int32_t& currentPositionMs) override;
     int32_t GetDuration(int32_t& durationMs) override;
     int32_t SetPlaybackSpeed(PlaybackRateMode mode) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
     int32_t GetPlaybackSpeed(PlaybackRateMode& mode) override;
     int32_t SelectBitRate(uint32_t bitRate) override;
     int32_t GetAudioEffectMode(int32_t &effectMode) override;
@@ -189,6 +190,11 @@ private:
 
     int32_t rotation90 = 90;
     int32_t rotation270 = 270;
+    std::map<std::string, std::string> header;
+    u_int32_t preferedWidth = 0;
+    u_int32_t preferedHeight = 0;
+    u_int32_t bufferDuration = 0;
+    bool preferHDR = false;
 };
 } // namespace Media
 } // namespace OHOS
diff --git a/services/include/i_player_service.h b/services/include/i_player_service.h
index 13ace880..e23f8e7e 100644
--- a/services/include/i_player_service.h
+++ b/services/include/i_player_service.h
@@ -277,6 +277,7 @@ public:
      */
     virtual int32_t SetPlaybackSpeed(PlaybackRateMode mode) = 0;
 
+    virtual int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) = 0;
     /**
      * @brief set the bit rate use for hls player
      *
diff --git a/services/services/engine_intf/i_player_engine.h b/services/services/engine_intf/i_player_engine.h
index 6ee15f86..5f71c42f 100644
--- a/services/services/engine_intf/i_player_engine.h
+++ b/services/services/engine_intf/i_player_engine.h
@@ -78,6 +78,7 @@ public:
     virtual int32_t GetDuration(int32_t &duration) = 0;
     virtual int32_t SetPlaybackSpeed(PlaybackRateMode mode) = 0;
     virtual int32_t GetPlaybackSpeed(PlaybackRateMode &mode) = 0;
+    virtual int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) = 0;
     virtual int32_t SetVideoSurface(sptr<Surface> surface) = 0;
 
     virtual int32_t SetDecryptConfig(const sptr<OHOS::DrmStandard::IMediaKeySessionService> &keySessionProxy,
diff --git a/services/services/player/client/player_client.cpp b/services/services/player/client/player_client.cpp
index 7d81ff27..5455d3a0 100644
--- a/services/services/player/client/player_client.cpp
+++ b/services/services/player/client/player_client.cpp
@@ -258,6 +258,13 @@ int32_t PlayerClient::SetPlaybackSpeed(PlaybackRateMode mode)
     return playerProxy_->SetPlaybackSpeed(mode);
 }
 
+int32_t PlayerClient::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy)
+{
+    std::lock_guard<std::mutex> lock(mutex_);
+    CHECK_AND_RETURN_RET_LOG(playerProxy_ != nullptr, MSERR_SERVICE_DIED, "player service does not exist..");
+    return playerProxy_->SetMediaSource(header, strategy);
+}
+
 int32_t PlayerClient::GetPlaybackSpeed(PlaybackRateMode &mode)
 {
     std::lock_guard<std::mutex> lock(mutex_);
diff --git a/services/services/player/client/player_client.h b/services/services/player/client/player_client.h
index efee98aa..60519684 100644
--- a/services/services/player/client/player_client.h
+++ b/services/services/player/client/player_client.h
@@ -52,6 +52,7 @@ public:
     int32_t GetAudioTrackInfo(std::vector<Format> &audioTrack) override;
     int32_t GetVideoHeight() override;
     int32_t SetPlaybackSpeed(PlaybackRateMode mode) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
     int32_t GetDuration(int32_t &duration) override;
     int32_t GetVideoTrackInfo(std::vector<Format> &videoTrack) override;
     int32_t GetVideoWidth() override;
diff --git a/services/services/player/ipc/i_standard_player_service.h b/services/services/player/ipc/i_standard_player_service.h
index ec760f87..33e4f226 100644
--- a/services/services/player/ipc/i_standard_player_service.h
+++ b/services/services/player/ipc/i_standard_player_service.h
@@ -55,6 +55,7 @@ public:
     virtual int32_t GetDuration(int32_t &duration) = 0;
     virtual int32_t SetPlaybackSpeed(PlaybackRateMode mode) = 0;
     virtual int32_t GetPlaybackSpeed(PlaybackRateMode &mode) = 0;
+    virtual int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) = 0;
 #ifdef SUPPORT_VIDEO
     virtual int32_t SetVideoSurface(sptr<Surface> surface) = 0;
 #endif
@@ -99,6 +100,7 @@ public:
         GET_DURATION,
         SET_PLAYERBACK_SPEED,
         GET_PLAYERBACK_SPEED,
+        SET_MEDIA_SOURCE,
         SET_VIDEO_SURFACE,
         IS_PLAYING,
         IS_LOOPING,
diff --git a/services/services/player/ipc/player_service_proxy.cpp b/services/services/player/ipc/player_service_proxy.cpp
index 4c2e124c..ab338123 100644
--- a/services/services/player/ipc/player_service_proxy.cpp
+++ b/services/services/player/ipc/player_service_proxy.cpp
@@ -70,6 +70,7 @@ PlayerServiceProxy::PlayerServiceProxy(const sptr<IRemoteObject> &impl)
     playerFuncs_[DESELECT_TRACK] = "Player::DeslectTrack";
     playerFuncs_[GET_CURRENT_TRACK] = "Player::GetCurrentTrack";
     playerFuncs_[SET_DECRYPT_CONFIG] = "Player::SetDecryptConfig";
+    playerFuncs_[SET_MEDIA_SOURCE] = "Player::SetMediaSource";
 }
 
 PlayerServiceProxy::~PlayerServiceProxy()
@@ -516,6 +517,43 @@ int32_t PlayerServiceProxy::SetPlaybackSpeed(PlaybackRateMode mode)
     return reply.ReadInt32();
 }
 
+int32_t PlayerServiceProxy::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy)
+{
+    MediaTrace trace("binder::SetMediaSource");
+    MessageParcel data;
+    MessageParcel reply;
+    MessageOption option;
+    MEDIA_LOGI("PlayerServiceProxy SetMediaSource");
+    bool token = data.WriteInterfaceToken(PlayerServiceProxy::GetDescriptor());
+    CHECK_AND_RETURN_RET_LOG(token, MSERR_INVALID_OPERATION, "Failed to write descriptor!");
+    auto headerSize = static_cast<uint32_t>(header.size());
+    if (!data.WriteUint32(headerSize)) {
+        MEDIA_LOGI("Write mapSize failed");
+        return MSERR_INVALID_OPERATION;
+    }
+    for (auto [kstr, vstr] : header) {
+        MEDIA_LOGI("PlayerServiceProxy SetMediaSource passed %{public}s", kstr.c_str());
+        if (!data.WriteString(kstr)) {
+            MEDIA_LOGI("Write kstr failed");
+            return MSERR_INVALID_OPERATION;
+        }
+        if (!data.WriteString(vstr)) {
+            MEDIA_LOGI("Write vstr failed");
+            return MSERR_INVALID_OPERATION;
+        }
+    }
+      MEDIA_LOGI("PlayerServiceProxy SetMediaSource passed");
+    (void)data.WriteUint32(strategy.preferedWidth);
+    (void)data.WriteUint32(strategy.preferedHeight);
+    (void)data.WriteUint32(strategy.preferedBufferDuration);
+    (void)data.WriteBool(strategy.preferHDR);
+    int32_t error = SendRequest(SET_MEDIA_SOURCE, data, reply, option);
+    CHECK_AND_RETURN_RET_LOG(error == MSERR_OK, MSERR_INVALID_OPERATION,
+        "SetMediaSource failed, error: %{public}d", error);
+    return reply.ReadInt32();
+
+}
+
 int32_t PlayerServiceProxy::GetPlaybackSpeed(PlaybackRateMode &mode)
 {
     MediaTrace trace("binder::GetPlaybackSpeed");
diff --git a/services/services/player/ipc/player_service_proxy.h b/services/services/player/ipc/player_service_proxy.h
index 6f782132..86782e64 100644
--- a/services/services/player/ipc/player_service_proxy.h
+++ b/services/services/player/ipc/player_service_proxy.h
@@ -37,6 +37,7 @@ public:
     int32_t GetAudioTrackInfo(std::vector<Format> &audioTrack) override;
     int32_t AddSubSource(const std::string &url) override;
     int32_t SetPlaybackSpeed(PlaybackRateMode mode) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
     int32_t AddSubSource(int32_t fd, int64_t offset, int64_t size) override;
     int32_t Seek(int32_t mSeconds, PlayerSeekMode mode) override;
     int32_t Stop() override;
diff --git a/services/services/player/ipc/player_service_stub.cpp b/services/services/player/ipc/player_service_stub.cpp
index 28875e80..6c792927 100644
--- a/services/services/player/ipc/player_service_stub.cpp
+++ b/services/services/player/ipc/player_service_stub.cpp
@@ -91,6 +91,7 @@ void PlayerServiceStub::SetPlayerFuncs()
     playerFuncs_[GET_DURATION] = { &PlayerServiceStub::GetDuration, "Player::GetDuration" };
     playerFuncs_[SET_PLAYERBACK_SPEED] = { &PlayerServiceStub::SetPlaybackSpeed, "Player::SetPlaybackSpeed" };
     playerFuncs_[GET_PLAYERBACK_SPEED] = { &PlayerServiceStub::GetPlaybackSpeed, "Player::GetPlaybackSpeed" };
+    playerFuncs_[SET_MEDIA_SOURCE] = { &PlayerServiceStub::SetMediaSource, "Player::SetMediaSource" };
 #ifdef SUPPORT_VIDEO
     playerFuncs_[SET_VIDEO_SURFACE] = { &PlayerServiceStub::SetVideoSurface, "Player::SetVideoSurface" };
 #endif
@@ -354,6 +355,13 @@ int32_t PlayerServiceStub::SetPlaybackSpeed(PlaybackRateMode mode)
     return playerServer_->SetPlaybackSpeed(mode);
 }
 
+int32_t PlayerServiceStub::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy)
+{
+    MediaTrace trace("binder::SetMediaSource");
+    CHECK_AND_RETURN_RET_LOG(playerServer_ != nullptr, MSERR_NO_MEMORY, "player server is nullptr");
+    return playerServer_->SetMediaSource(header,strategy);
+}
+
 int32_t PlayerServiceStub::GetPlaybackSpeed(PlaybackRateMode &mode)
 {
     MediaTrace trace("binder::GetPlaybackSpeed");
@@ -699,6 +707,28 @@ int32_t PlayerServiceStub::SetPlaybackSpeed(MessageParcel &data, MessageParcel &
     return MSERR_OK;
 }
 
+int32_t PlayerServiceStub::SetMediaSource(MessageParcel &data, MessageParcel &reply)
+{   
+    auto mapSize = data.ReadUint32();
+    std::map<std::string, std::string> headerMap;
+    while (mapSize--) {
+        auto kstr = data.ReadString();
+        auto vstr = data.ReadString();
+        MEDIA_LOGE("SetMediaSource kstr %{public}s  vstr %{public}s", kstr.c_str(), vstr.c_str());
+        headerMap.emplace(kstr, vstr);
+    }
+    
+    struct AVPlayStrategy strategy;
+    strategy.preferedWidth = data.ReadUint32();
+    strategy.preferedHeight = data.ReadUint32();
+    strategy.preferedBufferDuration = data.ReadUint32();
+    strategy.preferHDR = data.ReadBool();
+    MEDIA_LOGE("SetMediaSource preferedWidth %{public}d preferedHeight %{public}d preferedBufferDuration %{public}d preferHDR %{public}d", 
+        strategy.preferedWidth, strategy.preferedHeight, strategy.preferedBufferDuration, strategy.preferHDR);
+    reply.WriteInt32(SetMediaSource(headerMap, strategy));
+    return MSERR_OK;
+}
+
 int32_t PlayerServiceStub::GetPlaybackSpeed(MessageParcel &data, MessageParcel &reply)
 {
     (void)data;
diff --git a/services/services/player/ipc/player_service_stub.h b/services/services/player/ipc/player_service_stub.h
index 2cff901f..7f8f6171 100644
--- a/services/services/player/ipc/player_service_stub.h
+++ b/services/services/player/ipc/player_service_stub.h
@@ -72,6 +72,7 @@ public:
     int32_t DumpInfo(int32_t fd);
     int32_t DeselectTrack(int32_t index) override;
     int32_t GetCurrentTrack(int32_t trackType, int32_t &index) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
     bool IsPlaying() override;
     bool IsLooping() override;
     int32_t SetDecryptConfig(const sptr<DrmStandard::IMediaKeySessionService> &keySessionProxy,
@@ -129,6 +130,7 @@ private:
     int32_t DeselectTrack(MessageParcel &data, MessageParcel &reply);
     int32_t GetCurrentTrack(MessageParcel &data, MessageParcel &reply);
     int32_t SetDecryptConfig(MessageParcel &data, MessageParcel &reply);
+    int32_t SetMediaSource(MessageParcel &data, MessageParcel &reply);
     using PlayerStubFunc = int32_t(PlayerServiceStub::*)(MessageParcel &data, MessageParcel &reply);
     std::map<uint32_t, std::pair<PlayerStubFunc, std::string>> playerFuncs_;
 };
diff --git a/services/services/player/server/player_server.cpp b/services/services/player/server/player_server.cpp
index 4b07d250..fddb9e64 100755
--- a/services/services/player/server/player_server.cpp
+++ b/services/services/player/server/player_server.cpp
@@ -916,6 +916,12 @@ int32_t PlayerServer::HandleSetPlaybackSpeed(PlaybackRateMode mode)
     return MSERR_OK;
 }
 
+int32_t PlayerServer::SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) 
+{
+    (void)playerEngine_->SetMediaSource(header, strategy);
+    return MSERR_OK;
+}
+
 void PlayerServer::HandleEos()
 {
     if (config_.looping.load()) {
diff --git a/services/services/player/server/player_server.h b/services/services/player/server/player_server.h
index fe997ffd..50033572 100644
--- a/services/services/player/server/player_server.h
+++ b/services/services/player/server/player_server.h
@@ -96,6 +96,7 @@ public:
     int32_t AddSubSource(const std::string &url) override;
     int32_t AddSubSource(int32_t fd, int64_t offset, int64_t size) override;
     int32_t GetPlaybackSpeed(PlaybackRateMode &mode) override;
+    int32_t SetMediaSource(std::map<std::string, std::string> header, AVPlayStrategy strategy) override;
 #ifdef SUPPORT_VIDEO
     int32_t SetVideoSurface(sptr<Surface> surface) override;
 #endif
-- 
2.25.1

